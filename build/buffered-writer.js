"use strict";var EVENTS=require("events"),FS=require("fs"),BUFFER_SIZE=16384,EOL=process.platform.indexOf("win")!==-1?new Buffer([13,10]):new Buffer([10]),INVALID_BUFFER_SIZE=new Error("The buffer size must be greater than 0."),BufferedWriter=function(a,b,c,d){var e=arguments.length,f;e===1?(b=BUFFER_SIZE,c=null,d=!1):e===2?(f=typeof b,f==="string"?(c=b,b=BUFFER_SIZE,d=!1):f==="boolean"?(d=b,b=BUFFER_SIZE,c=null):(c=null,d=!1)):e===3&&(f=typeof b,f==="number"&&typeof c=="boolean"?(d=c,c=null):f==="string"?(d=c,c=b,b=BUFFER_SIZE):d=!1);if(b<1)throw INVALID_BUFFER_SIZE;this._settings={encoding:c,bufferSize:b,append:d?"a":"w"},this._fileName=a,this._fd=null,this._buffer=null,this._bufferOffset=0};BufferedWriter.prototype._getAvailableSpace=function(a){return a+this._bufferOffset>this._settings.bufferSize&&(a=this._settings.bufferSize-this._bufferOffset),a},BufferedWriter.prototype._open=function(a){if(this._fd)return a(null,this._fd);var b=this;FS.open(this._fileName,this._settings.append,function(c,d){if(c)return a(c,null);b._fd=d,b._buffer=new Buffer(b._settings.bufferSize),a(null,b._fd)})},BufferedWriter.prototype._write=function(a,b,c,d){var e=this;this._open(function(f,g){if(f){d&&d(f);return}var h=e._getAvailableSpace(c);a.copy(e._buffer,e._bufferOffset,b,b+h),e._bufferOffset+=h,b+=h,c-=h,e._bufferOffset===e._settings.bufferSize?e.flush(function(f){f?d&&d(f):c!==0&&e._write(a,b,c,d)}):d&&d(null)})},BufferedWriter.prototype.close=function(a){a&&(a=a.bind(this));if(!this._fd){a&&a(null);return}var b=function(){FS.close(c._fd,function(b){c._fd=null,c._buffer=null,a&&a(b)})},c=this;this._bufferOffset!==0?this.flush(function(c){c?a&&a(c):b()}):b()},BufferedWriter.prototype.flush=function(a){a&&(a=a.bind(this));if(!this._fd){a&&a(null);return}var b=this;FS.write(this._fd,this._buffer,0,this._bufferOffset,null,function(c){c?a&&a(c):(b._bufferOffset=0,a&&a(null))})},BufferedWriter.prototype.newLine=function(a){a&&(a=a.bind(this)),this._write(EOL,0,EOL.length,function(b){a&&a(b)})};var fixBufferType=function(a,b){var c=function(a){return Object.prototype.toString.call(a)==="[object Array]"};return b instanceof Buffer?b:c(b)?new Buffer(b):new Buffer([b])};BufferedWriter.prototype.write=function(a,b,c,d){if(typeof a=="string")d=b,b=0,c=a.length,a=new Buffer(a,this._settings.encoding);else{a=fixBufferType(this,a);var e=arguments.length;e===1?(b=0,c=1):e===2&&(d=b,b=0,c=1)}d&&(d=d.bind(this)),this._write(a,b,c,function(a){d&&d(a)})},module.exports=BufferedWriter;