"use strict";var EVENTS=require("events"),FS=require("fs"),BUFFER_SIZE=16384,EOL=process.platform.indexOf("win")!==-1?new Buffer([13,10]):new Buffer([10]),INVALID_BUFFER_SIZE=new Error("The buffer size must be greater than 0."),BufferedWriter=function(a,b,c,d){EVENTS.EventEmitter.call(this);var e=arguments.length,f;e===1?(b=BUFFER_SIZE,c=null,d=!1):e===2?(f=typeof b,f==="string"?(c=b,b=BUFFER_SIZE,d=!1):f==="boolean"?(d=b,b=BUFFER_SIZE,c=null):(c=null,d=!1)):e===3&&(f=typeof b,f==="number"&&typeof c=="boolean"?(d=c,c=null):f==="string"?(d=c,c=b,b=BUFFER_SIZE):d=!1);if(b<1)throw INVALID_BUFFER_SIZE;this._settings={encoding:c,bufferSize:b,append:d?"a":"w"},this._fileName=a,this._stream=null,this._buffer=null,this._bufferOffset=0};BufferedWriter.prototype=Object.create(EVENTS.EventEmitter.prototype),BufferedWriter.prototype.constructor=BufferedWriter,BufferedWriter.prototype._flush=function(){this._stream.write(this._bufferOffset!==this._settings._bufferSize?this._buffer.slice(0,this._bufferOffset):this._buffer),this._bufferOffset=0},BufferedWriter.prototype._getAvailableSpace=function(a){return a+this._bufferOffset>this._settings.bufferSize&&(a=this._settings.bufferSize-this._bufferOffset),a},BufferedWriter.prototype._write=function(a,b,c){var d=this;this._stream||(this._buffer=new Buffer(this._settings.bufferSize),this._stream=FS.createWriteStream(this._fileName,{flags:d._settings.append,encoding:d._settings.encoding}),this._stream.on("error",function(a){d.emit(a)}));var e=this._getAvailableSpace(c);a.copy(this._buffer,this._bufferOffset,b,b+e),this._bufferOffset+=e,b+=e,c-=e,this._bufferOffset===this._settings.bufferSize&&(this._flush(),c!==0&&this._write(a,b,c))},BufferedWriter.prototype.close=function(){if(!this._stream)return;this._bufferOffset!==0&&this._flush(),this._stream.end(),this._stream=null,this._buffer=null},BufferedWriter.prototype.newLine=function(){return this._write(EOL,0,EOL.length),this};var isArray=function(a){return Object.prototype.toString.call(a)==="[object Array]"},toHexArray=function(a){if(a===0)return[0];var b=[];while(a)b.push(255&a),a>>>=8;return b.reverse()};BufferedWriter.prototype.write=function(a,b,c){var d=typeof a;if(d==="number")b=0,a=toHexArray(a),c=a.length,a=new Buffer(a);else if(d==="string")b=0,c=a.length,a=new Buffer(a,this._settings.encoding);else{isArray(a)&&(a=new Buffer(a));var e=arguments.length;e===1&&(b=0,c=1)}return this._write(a,b,c),this},module.exports=BufferedWriter;